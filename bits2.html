<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glen Doman's Method - UI Shell</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="speech.js?4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #111827;
        }
        body::-webkit-scrollbar { display: none; }
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }

        #slide-container {
            --m: 4px; --t: 81px; --b:var(--m); 
            width: calc(100% - calc(var(--m) * 2)); height: calc(100% - var(--t) - var(--b)); margin: var(--t) var(--m) var(--b) var(--m); position: fixed; top: 0; left: 0;            
        }

        input[type=number] { appearance: textfield; background: #1f2937; border: 1px solid #4b5563; color: white; padding: 2px 8px; border-radius: 4px; width: 60px;}
    </style>
</head>
<body id="body" class="bg-gray-900 text-white overflow-hidden">
    <div id="app-container" class="w-full relative hidden">
        <div id="top-controls" class="absolute top-6 right-6 z-20 flex items-center space-x-4">
            <button id="play-pause-btn" onclick="UI.onClick_Play()" class="w-12 h-12 flex items-center justify-center bg-indigo-600 hover:bg-indigo-500 rounded-full transition-colors shadow-lg">
                <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="ml-1"><path d="M5 3l14 9-14 9V3z"></path></svg>
            </button>

            <div class="flex items-center space-x-2 text-sm">
                <span>Continuous</span>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="mode-toggle" onclick="window.Generator.isFirst=true" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="mode-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                </div>
                <span>Test</span>
            </div>
            <button onclick="UI.onClick_Settings(true)" class="w-10 h-10 flex items-center justify-center bg-gray-800/50 hover:bg-gray-700/70 rounded-full transition-colors backdrop-blur-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
            <button onclick="UI.onClick_Info(true)" class="w-10 h-10 flex items-center justify-center bg-gray-800/50 hover:bg-gray-700/70 rounded-full transition-colors backdrop-blur-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            </button>
        </div>

        <div id="slide-container" class="flex items-center justify-center">
             <h2 class="text-2xl text-gray-500">Press Play to Start</h2>
        </div>
    </div>

    <div id="start-screen" class="w-full h-screen flex items-center justify-center z-10">
        <div class="text-center p-8 max-w-2xl">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">Glen Doman's Method</h1>
            <p class="text-gray-300 md:text-lg mb-8">
                This interactive experience is based on Glen Doman's method of early childhood education, using "bits of information" to stimulate a child's capacity for learning.
            </p>
            <button onclick="UI.onClick_StartApp()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-8 rounded-full text-lg transition-transform transform hover:scale-105">
                Start
            </button>
        </div>
    </div>

    <div id="info-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 hidden backdrop-blur-sm">
        <div class="bg-gray-800 rounded-2xl p-8 max-w-2xl w-full relative shadow-2xl">
            <button onclick="UI.onClick_Info(false)" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4">About Glen Doman's Ideas</h2>
            <div class="space-y-4 text-gray-300">
                <p>
                    Glen Doman's method emphasizes the power of early education. Using bits of information, such as numbers represented by dots on cards, he believed that children could develop an exceptional capacity for learning when their natural curiosity is nurtured.
                </p>
                <p>
                    By presenting information in a simple, clear, and repetitive way, parents can encourage their children to grasp complex ideas effortlessly. His methods have inspired many to engage children with interactive and stimulating learning experiences.
                </p>
                <noscript>
                    <hr>
                    <div class="container">
                    <h3>JavaScript Disabled!</h3>
                    <p>JavaScript is required. Please enable JavaScript or use a modern browser like Netscape Navigator 4.0 or Internet Explorer 4.0 or later.</p>
                </noscript>                
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 hidden backdrop-blur-sm">
        <div class="bg-gray-800 rounded-2xl p-8 max-w-md w-full relative shadow-2xl">
            <button onclick="UI.onClick_Settings(false)" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h2 class="text-2xl font-bold mb-6">Settings</h2>
            <div id="settings-container" class="space-y-6 text-gray-300">
                <div>
                    <label for="language-select" class="block text-sm font-medium mb-2">Language</label>
                    <select id="language-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </select>
                </div>
                <div>
                    <label for="duration-slider" class="block text-sm font-medium mb-2">Slide Duration (seconds): <span id="duration-value">1</span></label>
                    <input type="range" id="duration-slider" min="0.5" max="3" step="0.25" value="1" oninput="_$('duration-value').innerHTML = parseInt(UI.slideDuration()/100)/10;" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
            <br>
            <div>
                <button onclick="toggleFullscreen()" class="w-full bg-indigo-600 text-white rounded-lg p-2 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Toggle Full Screen</button>
            </div>
        </div>
    </div>

    <script>
        const _$ = id => document.getElementById(id);
        const _cl = id => _$(id).classList;
        async function numToWords(number, lang){
          if (!window.n2words){
            await new Promise((resolve, reject)=>{
              const s=document.createElement('script');
              s.src="https://cdn.jsdelivr.net/npm/n2words@1.23.0/dist/n2words.min.js";
              s.onload=()=>resolve();
              s.onerror=()=>reject(new Error("failed to load n2words"));
              document.head.appendChild(s);
            });
          }
          return window.n2words(Number(number), { lang });
        }

        function numberToSentence(n, lang) {
            lang = lang.split('-')[0];
            const translations = {
                en: () => n === 1 ? `There is 1 red dot` : `There are ${n} red dots`,
                ar: () => {
                if (n === 0) return "لا نقاط حمراء";
                if (n === 1) return "يوجد 1 نقطة حمراء";
                if (n === 2) return "يوجد نقطتان حمراوان";
                if (n >= 3 && n <= 10) return `يوجد ${n} نقاط حمراء`;
                return `يوجد ${n} نقطة حمراء`;
                },
                az: () => n === 1 ? `Var 1 qırmızı nöqtə` : `Var ${n} qırmızı nöqtələr`,
                cz: () => {
                if (n === 1) return `Je 1 červená tečka`;
                if (n >= 2 && n <= 4) return `Jsou ${n} červené tečky`;
                return `Jsou ${n} červených teček`;
                },
                dk: () => n === 1 ? `Der er 1 rød prik` : `Der er ${n} røde prikker`,
                de: () => n === 1 ? `Es gibt 1 roter Punkt` : `Es gibt ${n} rote Punkte`,
                es: () => n === 1 ? `Hay 1 punto rojo` : `Hay ${n} puntos rojos`,
                fr: () => n === 1 ? `Il y a 1 point rouge` : `Il y a ${n} points rouges`,
                fa: () => n === 1 ? `وجود دارد 1 نقطه قرمز` : `وجود دارد ${n} نقاط قرمز`,
                he: () => n === 1 ? `יש 1 נקודה אדומה` : `יש ${n} נקודות אדומות`,
                hr: () => {
                if (n === 1) return `Ima 1 crvena točka`;
                if (n % 10 >= 2 && n % 10 <= 4 && (n % 100 < 10 || n % 100 > 20)) return `Ima ${n} crvene točke`;
                return `Ima ${n} crvenih točaka`;
                },
                hu: () => n === 1 ? `Van 1 piros pont` : `Vannak ${n} piros pontok`,
                id: () => `Ada ${n} titik merah`, // No plural distinction
                it: () => n === 1 ? `C'è 1 punto rosso` : `Ci sono ${n} punti rossi`,
                ko: () => n === 1 ? `있다 1 빨간 점` : `있다 ${n} 빨간 점들`,
                lt: () => {
                if (n === 1) return `Yra 1 raudonas taškas`;
                if (n % 10 === 0 || (n % 10 >= 2 && (n % 100 < 10 || n % 100 > 20))) return `Yra ${n} raudoni taškai`;
                return `Yra ${n} raudonų taškų`;
                },
                lv: () => {
                if (n === 1) return `Ir 1 sarkans punkts`;
                if (n === 0 || n % 10 === 0) return `Ir ${n} sarkanu punktu`;
                return `Ir ${n} sarkani punkti`;
                },
                nl: () => n === 1 ? `Er is 1 rode stip` : `Er zijn ${n} rode stippen`,
                no: () => n === 1 ? `Det er 1 rød prikk` : `Det er ${n} røde prikker`,
                pl: () => {
                if (n === 1) return `Jest 1 czerwona kropka`;
                if (n % 10 >= 2 && n % 10 <= 4 && (n % 100 < 10 || n % 100 > 20)) return `Są ${n} czerwone kropki`;
                return `Są ${n} czerwonych kropek`;
                },
                pt: () => n === 1 ? `Há 1 ponto vermelho` : `Há ${n} pontos vermelhos`,
                ru: () => {
                if (n === 1) return `Есть 1 красная точка`;
                if (n % 10 >= 2 && n % 10 <= 4 && (n % 100 < 10 || n % 100 > 20)) return `Есть ${n} красные точки`;
                return `Есть ${n} красных точек`;
                },
                sr: () => {
                if (n === 1) return `Ima 1 црвена тачка`;
                if (n % 10 >= 2 && n % 10 <= 4 && (n % 100 < 10 || n % 100 > 20)) return `Ima ${n} црвене тачке`;
                return `Ima ${n} црвених тачака`;
                },
                tr: () => n === 1 ? `Var 1 kırmızı nokta` : `Var ${n} kırmızı noktalar`,
                uk: () => {
                if (n === 1) return `Є 1 червона точка`;
                if (n % 10 >= 2 && n % 10 <= 4 && (n % 100 < 10 || n % 100 > 20)) return `Є ${n} червоні точки`;
                return `Є ${n} червоних точок`;
                },
                vi: () => `Có ${n} chấm đỏ`, // No plural distinction
                zh: () => n === 1 ? `有一个 1 红点` : `有 ${n} 个红点`
            };

            if (!translations[lang]) {
                console.warn(`Language ${lang} not supported, falling back to English`);
                return translations.en();
            }

            return translations[lang]();
        }

        function repeatAfterMe(lang) {
            lang = lang.split('-')[0];
            const translations = {
                en: () => "Repeat after me:",
                ar: () => "كرر بعدي:",
                az: () => "Məndən sonra təkrar et:",
                cz: () => "Opakuj po mně:",
                dk: () => "Gentag efter mig:",
                de: () => "Wiederhole nach mir:",
                es: () => "Repite después de mí:",
                fr: () => "Répète après moi:",
                fa: () => "بعد از من تکرار کن:",
                he: () => "חזור אחריי:",
                hr: () => "Ponovi za mnom:",
                hu: () => "Ismételj utánam:",
                id: () => "Ulangi setelah saya:",
                it: () => "Ripeti dopo di me:",
                ko: () => "나를 따라 반복해:",
                lt: () => "Kartok paskui mane:",
                lv: () => "Atkārto pēc manis:",
                nl: () => "Herhaal na mij:",
                no: () => "Gjenta etter meg:",
                pl: () => "Powtórz za mną:",
                pt: () => "Repita depois de mim:",
                ru: () => "Повторяй за мной:",
                sr: () => "Ponovi za mnom:",
                tr: () => "Benden sonra tekrarla:",
                uk: () => "Повторюй за мною:",
                vi: () => "Lặp lại theo tôi:",
                zh: () => "跟着我重复："
            };

            if (!translations[lang]) {
                console.warn(`Language ${lang} not supported, falling back to English`);
                return translations.en();
            }

            return translations[lang]();
        }        

        function toggleFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                document.documentElement.requestFullscreen();
            }
        }

        (async ()=>{
            const select = _$('language-select');
            const langs1 = new Set('en,ar,az,cz,dk,de,es,fr,fa,he,hr,hu,id,it,ko,lt,lv,nl,no,pl,pt,ru,sr,tr,uk,vi,zh'.split(','));
            const langs2 = await Speech.getLangs();

            const langs = langs2.filter(l=>langs1.has(l.split('-').shift()));
            const names = new Intl.DisplayNames(['en'], { type: 'language' });
            const _default = 'en-US';
            langs.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang;
                option.textContent = names.of(lang);
                if (lang === _default) option.selected = true;
                select.appendChild(option);
            });
        })();

        const UI = {
            DURATION_BASE: 3000,
            getMode() { return _$('mode-toggle').checked ? 'test' : 'continuous'; },
            play() { _cl('pause-icon').remove('hidden'); _cl('play-icon').add('hidden'); },
            pause() { _cl('pause-icon').add('hidden'); _cl('play-icon').remove('hidden'); },
            slideContainer() { return _$('slide-container'); },
            start(g) { UI.generator = g; },
            onClick_StartApp() { _cl('start-screen').add('hidden'); _cl('app-container').remove('hidden'); },
            onClick_Info(s) { _cl('info-modal').toggle('hidden', !s); },
            onClick_Settings(s) { _cl('settings-modal').toggle('hidden', !s); },
            isPlaying() {
                if (!_cl('info-modal').contains('hidden')) return false;
                return !_cl('pause-icon').contains('hidden');
            },
            async displaySlide(d) {
                const c = _$('slide-container');
                const S = c.style;
                const fadeTime = 1; // seconds (float)
                if (c) {
                    const aO = 2*Math.PI*Math.random();
                    const aI = 2*Math.PI*Math.random();
                    const H = 150;
                    const _wA = ()=>new Promise(r => requestAnimationFrame(r));
                    const _wF = ()=>new Promise(r => setTimeout(r, fadeTime*1000));

                    S.transition = `transform ${fadeTime}s`; await _wA();
                    S.transform = `translateX(${H * Math.sin(aO)}%) translateY(${H * Math.cos(aO)}%)`; await _wF();
                    c.innerHTML = '';
                    c.appendChild(d);
                    S.transform = `translateX(${H * Math.sin(aI)}%) translateY(${H * Math.cos(aI)}%)`;
                    S.transition = 'none';
                    await _wA();
                    S.transition = `transform ${fadeTime}s`; await _wA();
                    S.transform = 'translateX(0%)'; await _wF();
                }
            },
            onClick_Play() {
                if (!_cl('pause-icon').contains('hidden')) {
                    UI.pause();
                } else {
                    UI.play();
                    UI.generator.nextSlide();
                }
            },
            lang(){
                return _$('language-select').value;
            },
            slideDuration(){
                return parseInt(this.DURATION_BASE*parseFloat(_$('duration-slider').value));
            },
            addSettings(controls){
                _$('settings-container').append(...controls);
            }
        };
        class CircleGenerator extends SlideGenerator {
            constructor(isRandomSize = true) {
                super();
                this.isRandomSize = isRandomSize;
                this.isFirst = true;
                const S = document.createElement('div');
                S.innerHTML = `<div>
                    <label class="block text-sm font-medium mb-2">Quantity Range</label>
                    <div class="flex space-x-4">
                        <div>
                            <label for="min-quantity" class="block text-xs mb-1">Min</label>
                            <input type="range" id="min-quantity-slider" min="0" max="196" value="1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer" oninput="UI._circle.setMinQuantity(this.value)">
                            <input type="number" id="min-quantity" min="0" max="196" value="1" class="mt-2" oninput="UI._circle.setMinQuantity(this.value)">
                        </div>
                        <div>
                            <label for="max-quantity" class="block text-xs mb-1">Max</label>
                            <input type="range" id="max-quantity-slider" min="4" max="200" value="20" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer" oninput="UI._circle.setMaxQuantity(this.value)">
                            <input type="number" id="max-quantity" min="4" max="200" value="20" class="mt-2" oninput="UI._circle.setMaxQuantity(this.value)">
                        </div>
                    </div>
                </div>`;
                UI.addSettings(S.childNodes); // Custom UI controls.
                UI._circle = {
                    minQuantity: 1,
                    maxQuantity: 20,
                    setMinQuantity(value) {
                        const val = Math.max(0, Math.min(196, parseInt(value)));
                        this.minQuantity = val;
                        _$('min-quantity').value = val;
                        _$('min-quantity-slider').value = val;
                        // Ensure max is at least min + 4
                        const minMax = val + 4;
                        if (this.maxQuantity < minMax) {
                            this.setMaxQuantity(minMax);
                        }
                        _$('max-quantity-slider').min = minMax;
                        _$('max-quantity').min = minMax;
                    },
                    setMaxQuantity(value) {
                        const minVal = this.minQuantity + 4;
                        const val = Math.max(minVal, Math.min(200, parseInt(value)));
                        this.maxQuantity = val;
                        _$('max-quantity').value = val;
                        _$('max-quantity-slider').value = val;
                    },                    
                };
            }

            drawNext(n=null) {
                const [a,b] = [UI._circle.minQuantity, UI._circle.maxQuantity];
                this.currentNumber = n || (Math.floor(Math.random() * (b-a)) + a);
                this.slide = createCanvasWithCircles(this.currentNumber, true, UI.slideContainer());
                return UI.displaySlide(this.slide);
            }

            async awaitContinuous() {
                if(this.isFirst){
                    await Speech.speak(repeatAfterMe(UI.lang()), UI.lang());
                    await new Promise(r=>setTimeout(r, 800));
                    this.isFirst = false;
                }
                await Speech.speak(numberToSentence(this.currentNumber, UI.lang()), UI.lang());
                this.timeout = setTimeout(() => this.nextSlide(), UI.slideDuration());
            }

            async awaitTest() {
                let success = false;
                while(!success){
                    if(!UI.isPlaying()) return;
                    const N = this.currentNumber;
                    const L = UI.lang();
                    success = (await Speech.listen([`${N}`, await numToWords(N, L)], L, Math.floor(UI.slideDuration()*(2 + 1/3)) )).success;
                    if(success) {
                        return this.nextSlide();
                    }

                    await Speech.speak(repeatAfterMe(L), L);
                    await new Promise(r=>setTimeout(r, 800));
                    await Speech.speak(numberToSentence(this.currentNumber, L), L);
                }
            }
        }
        const G = new CircleGenerator(false);
        window.Generator = G;
        UI.start(G);
    </script>
    <script type="text/javascript" src="bits.compatibility.js?1"></script>
</body>
</html>
